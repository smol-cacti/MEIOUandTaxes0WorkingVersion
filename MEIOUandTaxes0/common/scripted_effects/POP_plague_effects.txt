plague_assign_plague_modifier = {
	if = {
		limit = {
			check_variable = { which = plague_strength_local value = 0.1 }	
		}
		set_variable = { which = plague_strength_local_adjusted which = plague_strength_local }
		set_variable = { which = province_plague_immunity_adjusted value = 200 }									# default max amount = 200 (temp)
		subtract_variable = { which = province_plague_immunity_adjusted which = province_plague_immunity }			# decreases by immunity (from max 200 to min 100, or increased by negative immunity)
		multiply_variable = { which = province_plague_immunity_adjusted value = 0.005 }								# drops to a percentage (100% to 50%) and converts to a decimal (1.00 to 0.50)
		multiply_variable = { which = plague_strength_local_adjusted which = province_plague_immunity_adjusted }	# decreases strength by half of immunity as percentage
		set_variable = { which = province_plague_immunity_adjusted value = 0 }
		if = {
			limit = {
				is_city = yes
			}
			if = {		limit = { owner = { has_country_flag = doctors_1 } }	multiply_variable = { which = plague_strength_local_adjusted value = 0.95 } }
			else_if = {	limit = { owner = { has_country_flag = doctors_2 } }	multiply_variable = { which = plague_strength_local_adjusted value = 0.9  } }
			else_if = {	limit = { owner = { has_country_flag = doctors_3 } }	multiply_variable = { which = plague_strength_local_adjusted value = 0.85 } }
		}
		multiply_variable = { which = plague_strength_local_adjusted value = 0.5 }
	}
	else = {
		set_variable = { which = plague_strength_local_adjusted value = 0 }
	}
	if = {
		limit = {
			OR = {
				is_city = yes
				is_colony = yes
			}
		}
		if = {
			limit = {
				check_variable = { which = plague_strength_local_adjusted value = 150 }
			}
			if = {
				limit = {
					NOT = { has_province_modifier = plague_devastating }
				}
				plague_remove_plague_modifier = yes
				add_permanent_province_modifier = {
					name = plague_devastating
					duration = 900
				}
			}
		}
		else_if = {
			limit = {
				check_variable = { which = plague_strength_local_adjusted value = 100 }
			}
			if = {
				limit = {
					NOT = { has_province_modifier = plague_terrible }
				}
				plague_remove_plague_modifier = yes
				add_permanent_province_modifier = {
					name = plague_terrible
					duration = 900
				}
			}
		}
		else_if = {
			limit = {
				check_variable = { which = plague_strength_local_adjusted value = 60 }
			}
			if = {
				limit = {
					NOT = { has_province_modifier = plague_severe }
				}
				plague_remove_plague_modifier = yes
				add_permanent_province_modifier = {
					name = plague_severe
					duration = 900
				}
			}
		}
		else_if = {
			limit = {
				check_variable = { which = plague_strength_local_adjusted value = 25 }
			}
			if = {
				limit = {
					NOT = { has_province_modifier = plague_moderate }
				}
				plague_remove_plague_modifier = yes
				add_permanent_province_modifier = {
					name = plague_moderate
					duration = 900
				}
			}
		}
		else_if = {
			limit = {
				check_variable = { which = plague_strength_local_adjusted value = 10 }
			}
			if = {
				limit = {
					NOT = { has_province_modifier = plague_mild }
				}
				plague_remove_plague_modifier = yes
				add_permanent_province_modifier = {
					name = plague_mild
					duration = 900
				}
			}
		}
		else_if = {
			limit = {
				NOT = { has_province_modifier = plague_passed_over }
			}
			plague_remove_plague_modifier = yes
			add_permanent_province_modifier = {
				name = plague_passed_over
				duration = 900
			}
		}
		set_variable = { which = plague_strength_local_adjusted value = 0 }
		owner = {
			if = {
				limit = {	
					NOT = { has_country_flag = plague_present_in_country }
				}
				country_event = {
					id = POP_Plague.010
					days = 1
				}
			}
		}
	}
	else = {
		if = {
			limit = {
				check_variable = { which = plague_strength_local_adjusted value = 150 }
			}
			if = {
				limit = {
					NOT = { has_province_modifier = plague_devastating_empty }
				}
				plague_remove_plague_empty_modifier = yes
				add_permanent_province_modifier = {
					name = plague_devastating_empty
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = { which = plague_strength_local_adjusted value = 100 }
			}
			if = {
				limit = {
					NOT = { has_province_modifier = plague_terrible_empty }
				}
				plague_remove_plague_empty_modifier = yes
				add_permanent_province_modifier = {
					name = plague_terrible_empty
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = { which = plague_strength_local_adjusted value = 60 }
			}
			if = {
				limit = {
					NOT = { has_province_modifier = plague_severe_empty }
				}
				plague_remove_plague_empty_modifier = yes
				add_permanent_province_modifier = {
					name = plague_severe_empty
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = { which = plague_strength_local_adjusted value = 25 }
			}
			if = {
				limit = {
					NOT = { has_province_modifier = plague_moderate_empty }
				}
				plague_remove_plague_empty_modifier = yes
				add_permanent_province_modifier = {
					name = plague_moderate_empty
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = { which = plague_strength_local_adjusted value = 10 }
			}
			if = {
				limit = {
					NOT = { has_province_modifier = plague_mild_empty }
				}
				plague_remove_plague_empty_modifier = yes
				add_permanent_province_modifier = {
					name = plague_mild_empty
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				NOT = { has_province_modifier = plague_passed_over_empty }
			}
			plague_remove_plague_empty_modifier = yes
			add_permanent_province_modifier = {
				name = plague_passed_over_empty
				duration = -1
			}
		}
	}

	set_province_flag = plague_attacked
	plague_kill_pop = yes
}

plague_adjoining_spread_effect = {
	if = {
		limit = {
			has_province_flag = plague_attacked
			check_variable = { which = plague_strength_local value = 5 }
		}
		every_neighbor_province = {
			limit = {
				is_city = yes
				NOT = { has_province_flag = plague_attacked }
			}
			plague_adjoining_spread_effect_core = yes
			plague_assign_plague_modifier = yes
	
			province_event = {
				id = POP_Plague.100
				days = 20
				random = 10
			}
			owner = {
				if = {
					limit = {
						NOT = { has_country_flag = plague_warning }
					}
					country_event = {
						id = POP_Plague.004
						days = 1
					}
				}
				every_neighbor_country = {
					limit = {
						NOT = { has_country_flag = plague_warning }
					}
					country_event = {
						id = POP_Plague.004
						days = 5
					}
				}
			}
		}
		every_empty_neighbor_province = {
			limit = {
				NOT = {
					has_province_flag = plague_attacked
					is_wasteland = yes
				}
			}
			plague_adjoining_spread_effect_core = yes
			plague_assign_plague_modifier = yes
			if = {
				limit = {
					has_province_flag = plague_attacked
					check_variable = { which = plague_strength_local value = 5 }
				}
				every_empty_neighbor_province = {
					limit = {
						NOT = {
							has_province_flag = plague_attacked
							is_wasteland = yes
						}
					}
					plague_adjoining_spread_effect_core = yes
					plague_assign_plague_modifier = yes
					every_neighbor_province = {
						limit = {
							is_city = yes
							NOT = { has_province_flag = plague_attacked }
						}
						plague_adjoining_spread_effect_core = yes
						plague_assign_plague_modifier = yes
				
						province_event = {
							id = POP_Plague.100
							days = 20
							random = 10
						}
						owner = {
							if = {
								limit = {
									NOT = { has_country_flag = plague_warning }
								}
								country_event = {
									id = POP_Plague.004
									days = 1
								}
							}
							every_neighbor_country = {
								limit = {
									NOT = { has_country_flag = plague_warning }
								}
								country_event = {
									id = POP_Plague.004
									days = 5
								}
							}
						}
					}
				}
				every_neighbor_province = {
					limit = {
						is_city = yes
						NOT = { has_province_flag = plague_attacked }
					}
					plague_adjoining_spread_effect_core = yes
					plague_assign_plague_modifier = yes
			
					province_event = {
						id = POP_Plague.100
						days = 20
						random = 10
					}
					owner = {
						if = {
							limit = {
								NOT = { has_country_flag = plague_warning }
							}
							country_event = {
								id = POP_Plague.004
								days = 1
							}
						}
						every_neighbor_country = {
							limit = {
								NOT = { has_country_flag = plague_warning }
							}
							country_event = {
								id = POP_Plague.004
								days = 5
							}
						}
					}
				}
			}
		}
	}
}

plague_spread_both = {
	if = {
		limit = {
			is_city = yes
		}
		province_event = {
			id = $ID$
			days = $DAYS$
			random = $RANDOM$
		}
		owner = {
			if = {
				limit = {
					NOT = { has_country_flag = plague_warning }
				}
				country_event = {
					id = POP_Plague.004
					days = 1
				}
			}
			every_neighbor_country = {
				limit = {
					NOT = { has_country_flag = plague_warning }
				}
				country_event = {
					id = POP_Plague.004
					days = 5
				}
			}
		}
	}
	else = {
		every_empty_neighbor_province = {
			limit = {
				NOT = {
					has_province_flag = plague_attacked
					is_wasteland = yes
				}
			}
			plague_adjoining_spread_effect_core = yes
			plague_assign_plague_modifier = yes
			if = {
				limit = {
					has_province_flag = plague_attacked
					check_variable = { which = plague_strength_local value = 5 }
				}
				every_empty_neighbor_province = {
					limit = {
						NOT = {
							has_province_flag = plague_attacked
							is_wasteland = yes
						}
					}
					plague_adjoining_spread_effect_core = yes
					plague_assign_plague_modifier = yes
					every_neighbor_province = {
						limit = {
							is_city = yes
							NOT = { has_province_flag = plague_attacked }
						}
						plague_adjoining_spread_effect_core = yes
						plague_assign_plague_modifier = yes
				
						province_event = {
							id = POP_Plague.100
							days = 20
							random = 10
						}
						owner = {
							if = {
								limit = {
									NOT = { has_country_flag = plague_warning }
								}
								country_event = {
									id = POP_Plague.004
									days = 1
								}
							}
							every_neighbor_country = {
								limit = {
									NOT = { has_country_flag = plague_warning }
								}
								country_event = {
									id = POP_Plague.004
									days = 5
								}
							}
						}
					}
				}
				every_neighbor_province = {
					limit = {
						is_city = yes
						NOT = { has_province_flag = plague_attacked }
					}
					plague_adjoining_spread_effect_core = yes
					plague_assign_plague_modifier = yes
			
					province_event = {
						id = POP_Plague.100
						days = 20
						random = 10
					}
					owner = {
						if = {
							limit = {
								NOT = { has_country_flag = plague_warning }
							}
							country_event = {
								id = POP_Plague.004
								days = 1
							}
						}
						every_neighbor_country = {
							limit = {
								NOT = { has_country_flag = plague_warning }
							}
							country_event = {
								id = POP_Plague.004
								days = 5
							}
						}
					}
				}
			}
		}
	}
}

plague_adjoining_spread_effect_core = {
	#set_variable = { which = plague_strength_local value = 0 }
	set_variable = { which = plague_strength_local which = PREV }
	set_variable = { which = plague_lost_on_spread which = province_plague_immunity }
	multiply_variable = { which = plague_lost_on_spread value = 0.20 }

	if = {	 #plague should never increase via spread, even if it doesn't decrease
		limit = {
			NOT = { check_variable = { which = plague_lost_on_spread value = 0.05 } } # Base spread loss
		}
		set_variable = { which = plague_lost_on_spread value = 0.05 }
	}
	
	# Terrain and climate impact
	if = {
		limit = {
			has_climate = arctic
		}
		change_variable = { which = plague_lost_on_spread		value = 2 }
	}
	if = {
		limit = {
			OR = {
				desert_trigger = yes
				has_terrain = tundra
			}
		}
		change_variable = { which = plague_lost_on_spread		value = 3 }
		if = {
			limit = {
				OR = {
					has_province_modifier = oasis_route # Oasis provinces are hubs for merchants and people in general
					has_province_flag = good_natural_place
					has_province_flag = great_natural_place
					has_province_flag = awesome_natural_place
				}
			}
			change_variable = { which = plague_lost_on_spread		value = -2 }
		}
	}
	else_if = {
		limit = {
			OR = {
				jungle_trigger = yes
				mountains_trigger = yes
			}
		}
		change_variable = { which = plague_lost_on_spread		value = 2 }
		if = {
			limit = {
				OR = {
					has_province_modifier = oasis_route
					has_province_flag = good_natural_place
					has_province_flag = great_natural_place
					has_province_flag = awesome_natural_place
				}
			}
			change_variable = { which = plague_lost_on_spread		value = -1 }
		}
	}
	else_if = {
		limit = {
			OR = {
				forest_trigger = yes
				highlands_trigger = yes
				has_terrain = taiga
				AND = {
					has_terrain = marsh
					NOT = { has_province_flag = marsh_developed }
				}
			}
			NOT = {
				has_province_flag = good_natural_place
				has_province_flag = great_natural_place
				has_province_flag = awesome_natural_place
			}
		}
		change_variable = { which = plague_lost_on_spread		value = 1 }
	}
	else_if = {
		limit = {
			OR = {
				hills_trigger = yes
				AND = {
					wood_trigger = yes
					farming_province_trigger = no
				}
				AND = {
					has_terrain = marsh
					has_province_flag = marsh_developed
				}
			}
			NOT = {
				has_province_flag = good_natural_place
				has_province_flag = great_natural_place
				has_province_flag = awesome_natural_place
			}
		}
		change_variable = { which = plague_lost_on_spread		value = 0.5 }
	}
	#multiply_variable = { which = plague_lost_on_spread value = 2 }
	random_list = { #random loss from spread, things happen
		1 = { change_variable = { which = plague_lost_on_spread value = 4 } }
		1 = { change_variable = { which = plague_lost_on_spread value = 6 } }
		1 = { change_variable = { which = plague_lost_on_spread value = 8 } }
		1 = { change_variable = { which = plague_lost_on_spread value = 10 } }
		1 = { change_variable = { which = plague_lost_on_spread value = 12 } }
		1 = { change_variable = { which = plague_lost_on_spread value = 14 } }
	}

	if = {
		limit = {
			is_city = yes
		}
		if = {		limit = { owner = { has_country_flag = doctors_1 } }	multiply_variable = { which = plague_lost_on_spread value = 1.1 } }
		else_if = {	limit = { owner = { has_country_flag = doctors_2 } }	multiply_variable = { which = plague_lost_on_spread value = 1.2 } }
		else_if = {	limit = { owner = { has_country_flag = doctors_3 } }	multiply_variable = { which = plague_lost_on_spread value = 1.3 } }
	}
	else = {
		multiply_variable = { which = plague_strength_local value = 0.75 }
	}
	
	set_variable = { which = plague_density_adjustment which = prov_size } #large provinces slow plagues down more
	multiply_variable = { which = plague_density_adjustment value = 0.13 } #TUNING, we also need to make sure it doesn't decrease too much
	divide_variable = { which = plague_density_adjustment which = total_pop } #whereas more population make plagues spread far more quickly
	if = {	 #bounding of population density effects
		limit = {
			NOT = { check_variable = { which = plague_density_adjustment value = 0.3 } }
		}
		set_variable = { which = plague_density_adjustment value = 0.3 }	#can reduce it to 30% slowing
	}
	if = {	 #bounding of size effects
		limit = {
			check_variable = { which = plague_density_adjustment value = 4.0 }
		}
		set_variable = { which = plague_density_adjustment value = 4.0 }	#can increase it to 400% more slowing
	}
	multiply_variable = { which = plague_lost_on_spread which = plague_density_adjustment } #apply population density slowing
	set_variable = { which = plague_density_adjustment value = 0 }
	
	if = {	 #plague should never increase via spread, even if it doesn't decrease
		limit = {
			NOT = { check_variable = { which = plague_lost_on_spread value = 0.001 } }
		}
		set_variable = { which = plague_lost_on_spread value = 0 }
	}
	else = {
		subtract_variable = { which = plague_strength_local which = plague_lost_on_spread }
		set_variable = { which = plague_lost_on_spread value = 0 }
	}
}

plague_trade_center_spread_target = {
	if = {
		limit = {
			has_province_flag = plague_attacked
			check_variable = { which = plague_strength_local value = 21 }
			OR = {
				has_province_flag = trade_center_modifier_has
				has_province_flag = good_natural_place
				has_province_flag = great_natural_place
				has_province_flag = awesome_natural_place
			}
		}
		set_province_flag = plague_spread_origin
		if = {
			limit = {
				OR = {
					has_province_flag = good_natural_place
					has_province_flag = great_natural_place
					has_province_flag = awesome_natural_place
				}
			}
			set_global_flag = temp1																		# a natural place
		}
		trigger_switch = {
			on_trigger = has_province_modifier
			minor_center_of_trade		= {	set_global_flag = temp2	}
			important_center_of_trade	= {	set_global_flag = temp3	}
			major_center_of_trade		= { set_global_flag = temp4	}
			dominant_center_of_trade	= { set_global_flag = temp5	}
		}
#		1540 = {																						# tuning max distance: Havana to Lisbon
#			230 = {
#				calc_dist_init = { targ=PREV x_coord=x_coord y_coord=y_coord }
#				calc_dist = yes
#				set_variable = { 		which = plague_timer	which = distance	}
#				multiply_variable = {	which = plague_timer	value = 0.7			}					# Havana: port
#				multiply_variable = {	which = plague_timer	value = 0.7			}					# Lisbon: port
#				multiply_variable = {	which = plague_timer	value = 0.8			}					# Lisbon: important_center_of_trade
#				multiply_variable = {	which = plague_timer	value = 0.9			}					# Havana: natural place
#				multiply_variable = {	which = plague_timer	value = 0.9			}					# Lisbon: natural place
#				multiply_variable = {	which = plague_timer	value = 0.125		}					# tuning
#				if = { limit = { check_variable = { which = plague_timer value = 15 }}	log = "a15"	}
#				if = { limit = { check_variable = { which = plague_timer value = 20 }}	log = "a20"	}
#				if = { limit = { check_variable = { which = plague_timer value = 25 }}	log = "a25"	}
#				if = { limit = { check_variable = { which = plague_timer value = 30 }}	log = "a30"	}
#				if = { limit = { check_variable = { which = plague_timer value = 35 }}	log = "a35"	}
#				if = { limit = { check_variable = { which = plague_timer value = 45 }}	log = "a45"	}	# currently 45-50
#				if = { limit = { check_variable = { which = plague_timer value = 50 }}	log = "a50"	}	
#				if = { limit = { check_variable = { which = plague_timer value = 55 }}	log = "a55"	}
#				if = { limit = { check_variable = { which = plague_timer value = 60 }}	log = "a60"	}
#				if = { limit = { check_variable = { which = plague_timer value = 65 }}	log = "a65"	}
#				if = { limit = { check_variable = { which = plague_timer value = 70 }}	log = "a70"	}
#				if = { limit = { check_variable = { which = plague_timer value = 75 }}	log = "a75"	}
#				if = { limit = { check_variable = { which = plague_timer value = 80 }}	log = "a80"	}
#			}
#		}
#		3645 = {																						# tuning max distance: Toronto to Manhattan Bay
#			2197 = {
#				calc_dist_init = { targ=PREV x_coord=x_coord y_coord=y_coord }
#				calc_dist = yes
#				set_variable = { 		which = plague_timer	which = distance	}
#				multiply_variable = {	which = plague_timer	value = 0.7			}					# Manhattan Bay: port
#				multiply_variable = {	which = plague_timer	value = 0.8			}					# Toronto: important_center_of_trade
#				multiply_variable = {	which = plague_timer	value = 0.9			}					# Manhattan Bay: natural place
#				multiply_variable = {	which = plague_timer	value = 0.9			}					# Toronto: natural place
#				multiply_variable = {	which = plague_timer	value = 0.125		}					# tuning
#				if = { limit = { check_variable = { which = plague_timer value = 1 }}	log = "b1"	}
#				if = { limit = { check_variable = { which = plague_timer value = 2 }}	log = "b2"	}
#				if = { limit = { check_variable = { which = plague_timer value = 4 }}	log = "b4"	}	# currently 4-6
#				if = { limit = { check_variable = { which = plague_timer value = 6 }}	log = "b6"	}
#				if = { limit = { check_variable = { which = plague_timer value = 8 }}	log = "b8"	}
#				if = { limit = { check_variable = { which = plague_timer value = 10 }}	log = "b10"	}
#				if = { limit = { check_variable = { which = plague_timer value = 15 }}	log = "b15"	}
#				if = { limit = { check_variable = { which = plague_timer value = 20 }}	log = "b20"	}
#			}
#		}
#		845 = {																							# tuning max distance: Ah Canul to Chalchichuecan
#			4040 = {
#				calc_dist_init = { targ=PREV x_coord=x_coord y_coord=y_coord }
#				calc_dist = yes
#				set_variable = { 		which = plague_timer	which = distance	}
#				multiply_variable = {	which = plague_timer	value = 0.7			}					# Ah Canul: port
#				multiply_variable = {	which = plague_timer	value = 0.7			}					# Chalchichuecan: port
#				multiply_variable = {	which = plague_timer	value = 0.8			}					# Ah Canul: important_center_of_trade
#				multiply_variable = {	which = plague_timer	value = 0.9			}					# Chalchichuecan: natural place
#				multiply_variable = {	which = plague_timer	value = 0.125		}					# tuning
#				if = { limit = { check_variable = { which = plague_timer value = 1 }}	log = "c1"	}
#				if = { limit = { check_variable = { which = plague_timer value = 2 }}	log = "c2"	}
#				if = { limit = { check_variable = { which = plague_timer value = 4 }}	log = "c4"	}	# currently 4-6	
#				if = { limit = { check_variable = { which = plague_timer value = 6 }}	log = "c6"	}
#				if = { limit = { check_variable = { which = plague_timer value = 8 }}	log = "c8"	}
#				if = { limit = { check_variable = { which = plague_timer value = 10 }}	log = "c10"	}
#				if = { limit = { check_variable = { which = plague_timer value = 15 }}	log = "c15"	}
#				if = { limit = { check_variable = { which = plague_timer value = 20 }}	log = "c20"	}
#			}
#		}
		every_province = {
			limit = {
				is_city = yes
				OR = {
					has_province_flag = trade_center_modifier_has
					has_province_flag = good_natural_place
					has_province_flag = great_natural_place
					has_province_flag = awesome_natural_place
				}
				NOT = {
					has_province_flag = no_plagues
					has_province_flag = plague_attacked
					has_province_flag = plague_spread_origin
					has_province_flag = plague_trade_center_spread_check
				}
			}
			calc_dist_init = { targ=ROOT x_coord=x_coord y_coord=y_coord }
			calc_dist = yes
			set_variable = { 																		which = plague_timer	which = distance }
			set_variable = { which = plague_dist_save which = distance }
			multiply_variable = { which = plague_dist_save value = 0.5 }
			if = { limit = { has_port = yes }								multiply_variable = {	which = plague_timer	value = 0.7	} }
			if = { limit = { ROOT = { has_port = yes } }					multiply_variable = {	which = plague_timer	value = 0.7	} }
			trigger_switch = {
				on_trigger = has_global_flag
				temp2 = {	set_province_flag = plague_target_minor			multiply_variable = {	which = plague_timer	value = 0.9	} }
				temp3 = {	set_province_flag = plague_target_important		multiply_variable = {	which = plague_timer	value = 0.8	} }
				temp4 = {	set_province_flag = plague_target_major			multiply_variable = {	which = plague_timer	value = 0.65	} }
				temp5 = {	set_province_flag = plague_target_dominant		multiply_variable = {	which = plague_timer	value = 0.5	} }				
				temp1 = {	set_province_flag = plague_target_minor																		  }
			}
			if = { limit = { has_global_flag = temp1 }						multiply_variable = {	which = plague_timer	value = 0.9	} }
			trigger_switch = {
				on_trigger = has_province_modifier
				minor_center_of_trade		= {								multiply_variable = {	which = plague_timer	value = 0.9	} }
				important_center_of_trade	= {								multiply_variable = {	which = plague_timer	value = 0.8	} }
				major_center_of_trade		= {								multiply_variable = {	which = plague_timer	value = 0.65	} }
				dominant_center_of_trade	= {								multiply_variable = {	which = plague_timer	value = 0.5	} }
			}
			if = { 
				limit = {
					OR = {
						has_province_flag = good_natural_place
						has_province_flag = great_natural_place
						has_province_flag = awesome_natural_place
					}
				}
				multiply_variable = {																which = plague_timer	value = 0.9	}
			}
			multiply_variable = {																	which = plague_timer	value = 0.125 }		# tuning
			if = {
				limit = { NOT = { check_variable = { which = plague_timer value = 30 } } }
				if = {
					limit = { NOT = { check_variable = { which = plague_strength_local which = ROOT } } }
					set_variable = { which = plague_strength_local which = ROOT }
				}
				if = {
					limit = {				  check_variable = { which = plague_timer value = 15 } }
					if = {
						limit = {			  check_variable = { which = plague_timer value = 22 } }
						if = {		limit = { check_variable = { which = plague_timer value = 27 } }	plague_spread_both = { ID = POP_Plague.99	DAYS = 65	RANDOM = 65 } }
						else_if = {	limit = { check_variable = { which = plague_timer value = 25 } }	plague_spread_both = { ID = POP_Plague.99	DAYS = 60	RANDOM = 60 } }
						else	= {																		plague_spread_both = { ID = POP_Plague.99	DAYS = 55	RANDOM = 55 } }
					}
					else = {
						if = {		limit = { check_variable = { which = plague_timer value = 20 } }	plague_spread_both = { ID = POP_Plague.99	DAYS = 50	RANDOM = 50 } }
						else_if = {	limit = { check_variable = { which = plague_timer value = 17 } }	plague_spread_both = { ID = POP_Plague.99	DAYS = 45	RANDOM = 45 } }
						else	= {																		plague_spread_both = { ID = POP_Plague.99	DAYS = 40	RANDOM = 40 } }
					}
				}
				else = {
					if = {
						limit = {			  check_variable = { which = plague_timer value = 7 } }
						if = {		limit = { check_variable = { which = plague_timer value = 12 } }	plague_spread_both = { ID = POP_Plague.99	DAYS = 35	RANDOM = 35 } }
						else_if = {	limit = { check_variable = { which = plague_timer value = 10 } }	plague_spread_both = { ID = POP_Plague.99	DAYS = 30	RANDOM = 30 } }
						else	= {																		plague_spread_both = { ID = POP_Plague.99	DAYS = 20	RANDOM = 20 } }
					}
					else = {
						if = {		limit = { check_variable = { which = plague_timer value = 5 } }		plague_spread_both = { ID = POP_Plague.99	DAYS = 15	RANDOM = 15 } }
						else_if = {	limit = { check_variable = { which = plague_timer value = 2 } }		plague_spread_both = { ID = POP_Plague.99	DAYS = 10	RANDOM = 10 } }
						else	= {																		plague_spread_both = { ID = POP_Plague.99	DAYS = 5	RANDOM = 5 } }
					}
				}
			}
			set_variable = { which = plague_timer	value = 0 }
		}
		clr_province_flag = plague_spread_origin
		clr_global_flag = temp1
		clr_global_flag = temp2
		clr_global_flag = temp3
		clr_global_flag = temp4
		clr_global_flag = temp5
	}
}

plague_trade_center_spread_fire = {
	if = {
		limit = {
			check_variable = { which = plague_strength_local value = 1 }
			NOT = { has_province_flag = plague_trade_center_spread_check }
			OR = {
				has_province_flag = plague_target_dominant
				has_province_flag = plague_target_major
				has_province_flag = plague_target_important
				has_province_flag = plague_target_minor
			}
		}
		set_province_flag = plague_trade_center_spread_check
		set_variable = { which = spread_yes value = 0 }
		if = {
			limit = { has_province_flag = plague_target_dominant }
			clr_province_flag = plague_target_dominant
			if = {
				limit = { has_port = no }
				if = { limit = { owner = { has_country_flag = trade_restricted } }	random = { chance = 10 set_variable = { which = spread_yes value = 1 } } }
				else = {															random = { chance = 20 set_variable = { which = spread_yes value = 1 } } }
			}
			else_if = {
				limit = { owner = { has_country_flag = plague_ports_closed } }
				if = { limit = { owner = { has_country_flag = trade_restricted } }	random = { chance = 20 set_variable = { which = spread_yes value = 1 } } }
				else = {															random = { chance = 40 set_variable = { which = spread_yes value = 1 } } }
			}
			else = {
				if = { limit = { owner = { has_country_flag = trade_restricted } }	random = { chance = 40 set_variable = { which = spread_yes value = 1 } } }
				else = {															random = { chance = 80 set_variable = { which = spread_yes value = 1 } } }
			}
		}
		else_if = {
			limit = { has_province_flag = plague_target_major }
			clr_province_flag = plague_target_major
			if = {
				limit = { has_port = no }
				if = { limit = { owner = { has_country_flag = trade_restricted } }	random = { chance =  8 set_variable = { which = spread_yes value = 1 } } }
				else = {															random = { chance = 15 set_variable = { which = spread_yes value = 1 } } }
			}
			else_if = {
				limit = { owner = { has_country_flag = plague_ports_closed } }
				if = { limit = { owner = { has_country_flag = trade_restricted } }	random = { chance = 15 set_variable = { which = spread_yes value = 1 } } }
				else = {															random = { chance = 30 set_variable = { which = spread_yes value = 1 } } }
			}
			else = {
				if = { limit = { owner = { has_country_flag = trade_restricted } }	random = { chance = 30 set_variable = { which = spread_yes value = 1 } } }
				else = {															random = { chance = 60 set_variable = { which = spread_yes value = 1 } } }
			}
		}
		else_if = {
			limit = { has_province_flag = plague_target_important }
			clr_province_flag = plague_target_important
			if = {
				limit = { has_port = no }
				if = { limit = { owner = { has_country_flag = trade_restricted } }	random = { chance =  7 set_variable = { which = spread_yes value = 1 } } }
				else = {															random = { chance = 13 set_variable = { which = spread_yes value = 1 } } }
			}
			else_if = {
				limit = { owner = { has_country_flag = plague_ports_closed } }
				if = { limit = { owner = { has_country_flag = trade_restricted } }	random = { chance = 13 set_variable = { which = spread_yes value = 1 } } }
				else = {															random = { chance = 25 set_variable = { which = spread_yes value = 1 } } }
			}
			else = {
				if = { limit = { owner = { has_country_flag = trade_restricted } }	random = { chance = 25 set_variable = { which = spread_yes value = 1 } } }
				else = {															random = { chance = 50 set_variable = { which = spread_yes value = 1 } } }
			}
		}
		else = {
			limit = { has_province_flag = plague_target_minor }
			clr_province_flag = plague_target_minor
			if = {
				limit = { has_port = no }
				if = { limit = { owner = { has_country_flag = trade_restricted } }	random = { chance =  5 set_variable = { which = spread_yes value = 1 } } }
				else = {															random = { chance = 10 set_variable = { which = spread_yes value = 1 } } }
			}
			else_if = {
				limit = { owner = { has_country_flag = plague_ports_closed } }
				if = { limit = { owner = { has_country_flag = trade_restricted } }	random = { chance = 10 set_variable = { which = spread_yes value = 1 } } }
				else = {															random = { chance = 20 set_variable = { which = spread_yes value = 1 } } }
			}
			else = {
				if = { limit = { owner = { has_country_flag = trade_restricted } }	random = { chance = 20 set_variable = { which = spread_yes value = 1 } } }
				else = {															random = { chance = 40 set_variable = { which = spread_yes value = 1 } } }
			}
		}
		if = {
			limit = { check_variable = { which = spread_yes value = 1 } }
			if = {
				limit = { check_variable = { which = province_plague_immunity value = 0 } }
				set_variable = { which = province_plague_immunity_adjusted value = 200 }									# default max amount = 200 (temp)
				subtract_variable = { which = province_plague_immunity_adjusted which = province_plague_immunity }			# decreases by immunity (from max 200 to min 100, or increased by negative immunity)
				multiply_variable = { which = province_plague_immunity_adjusted value = 0.005 }								# drops to a percentage (100% to 50%) and converts to a decimal (1.00 to 0.50)
				multiply_variable = { which = plague_strength_local which = province_plague_immunity_adjusted }				# decreases strength by half of immunity as percentage
				set_variable = { which = province_plague_immunity_adjusted value = 0 }
			}
			set_variable = { which = plague_lost_on_spread which = province_plague_immunity }
			multiply_variable = { which = plague_lost_on_spread value = 0.20 }
			change_variable = { which = plague_lost_on_spread value = 1 }
			if = {
				limit = {
					check_variable = { which = plague_dist_save value = 0.001 }
				}
				change_variable = { which = plague_lost_on_spread which = plague_dist_save }
			}
			random_list = {
				1 = { change_variable = { which = plague_lost_on_spread value = 20 } }
				1 = { change_variable = { which = plague_lost_on_spread value = 24 } }
				1 = { change_variable = { which = plague_lost_on_spread value = 28 } }
				1 = { change_variable = { which = plague_lost_on_spread value = 32 } }
				1 = { change_variable = { which = plague_lost_on_spread value = 36 } }
				1 = { change_variable = { which = plague_lost_on_spread value = 40 } }
			}
			if = {
				limit = {
					is_city = yes
				}
				if = {		limit = { owner = { has_country_flag = doctors_1 } }	multiply_variable = { which = plague_lost_on_spread value = 1.1 } }
				else_if = {	limit = { owner = { has_country_flag = doctors_2 } }	multiply_variable = { which = plague_lost_on_spread value = 1.2 } }
				else_if = {	limit = { owner = { has_country_flag = doctors_3 } }	multiply_variable = { which = plague_lost_on_spread value = 1.3 } }
			}
			if = {
				limit = {
					NOT = { check_variable = { which = plague_lost_on_spread value = 0.05 } } # Base spread loss
				}
				set_variable = { which = plague_lost_on_spread value = 0.05 }
			}
			subtract_variable = { which = plague_strength_local which = plague_lost_on_spread }
			set_variable = { which = plague_lost_on_spread value = 0 }
			
			plague_assign_plague_modifier = yes
			plague_spread_both = {	ID = POP_Plague.100		DAYS = 10	RANDOM = 10	}
		}
	}
}

plague_add_immunity = {		#provinces gains immunity equal to half percentage losses. So 20% dead would give 10 immunity
	set_variable = {		which = province_immunity_gained     which = plague_death_total_count }
	divide_variable = {		which = province_immunity_gained     which = total_pop }
	multiply_variable = {	which = province_immunity_gained     value = 50 }
	change_variable = {		which = province_plague_immunity     which = province_immunity_gained }
	if = { #this caps immunity at 100, no population is entirely safe.
		limit = {
			check_variable = {	which = province_plague_immunity     value = 100 }
		}
		set_variable = {		which = province_plague_immunity     value = 100 }
	}
	set_variable = {		which = province_immunity_gained     value = 0 } # Cleanup
}

plague_kill_pop = {
	if = {
		limit = {
			NOT = { has_province_flag = plague_population_death_applied }
		}
		set_variable = { which = plague_strength_local_adjusted which = plague_strength_local }
		set_variable = { which = province_plague_immunity_adjusted value = 200 }									# default max amount = 200 (temp)
		subtract_variable = { which = province_plague_immunity_adjusted which = province_plague_immunity }			# decreases by immunity (from max 200 to min 100, or increased by negative immunity)
		multiply_variable = { which = province_plague_immunity_adjusted value = 0.005 }								# drops to a percentage (100% to 50%) and converts to a decimal (1.00 to 0.50)
		multiply_variable = { which = plague_strength_local_adjusted which = province_plague_immunity_adjusted }	# decreases strength by half of immunity as percentage
		set_variable = { which = province_plague_immunity_adjusted value = 0 }
		if = {
			limit = {
				is_city = yes
			}
			if = {		limit = { owner = { has_country_flag = doctors_1 } } multiply_variable = { which = plague_strength_local_adjusted value = 0.9 } }
			else_if = {	limit = { owner = { has_country_flag = doctors_2 } } multiply_variable = { which = plague_strength_local_adjusted value = 0.8 } }
			else_if = {	limit = { owner = { has_country_flag = doctors_3 } } multiply_variable = { which = plague_strength_local_adjusted value = 0.7 } }
		}	
		multiply_variable = { which = plague_strength_local_adjusted value = 0.5 }
		if = {
			limit = {
				NOT = { check_variable = { which = plague_strength_local_adjusted value = 1 } }
			}
			set_province_flag = plague_population_death_applied
			set_variable = { which = plague_strength_local_adjusted value = 0 }
		}
		else = {
			#set_variable = {		which = plague_province_trauma	value = 0 }
			#set_variable = {		which = plague_urban_death		value = 0 }
			#set_variable = {		which = plague_rural_death		value = 0 }
			if = {
				limit = {
					check_variable = { which = plague_strength_local_adjusted value = 150 }
				}
				set_variable = {	which = plague_urban_death		value = 225 } #changed from 150 by 1.5x to make the plague target the urbans more
				set_variable = {	which = plague_rural_death		value = 75 } #changed from 150 by 0.5x to make the plague target the rurals less
				set_variable = {	which = plague_province_trauma	value = 150 }
			}
			else = {
				set_variable = {	which = plague_urban_death		which = plague_strength_local_adjusted }
				multiply_variable = {	which = plague_urban_death		value = 1.25 }
				set_variable = {	which = plague_rural_death		which = plague_strength_local_adjusted }
				multiply_variable = {	which = plague_rural_death		value = 0.75 }
				set_variable = {	which = plague_province_trauma	which = plague_strength_local_adjusted }
			}
			divide_variable = {		which = plague_province_trauma	value = 60 }
			#divide_variable = {		which = plague_province_trauma	value = 30 }
			#multiply_variable = {	which = plague_province_trauma	value = 0.5 }
			
			if = {
				limit = {
					OR = {
						is_city = yes
						is_colony = yes
					}
				}
				province_trauma_effect_var = { amountvar = plague_province_trauma }
			}
			else = {
				if = {
					limit = {
						NOT = { check_variable = { which = province_trauma value = 0.001 } }
					}
					set_variable = { which = province_trauma	which = plague_province_trauma }
				}
				else = {
					change_variable = { which = province_trauma	which = plague_province_trauma }
				}
			}
			if = {
				limit = {
					NOT = { check_variable = { which = province_trauma value = 0.001 } }
				}
				set_variable = { which = province_trauma	which = plague_province_trauma }
			}
			else = {
				change_variable = { which = province_trauma	which = plague_province_trauma }
			}
			
			if = {
				limit = { is_city = yes }
				if = {
					limit = { check_variable = { which = urban_pop value = 1 } }
					trigger_switch = {
						on_trigger = has_building
						town_hall = {				multiply_variable = { which = plague_urban_death value = 0.975 } }
						urban_infrastructure_1 = {	multiply_variable = { which = plague_urban_death value = 0.95 } }
						urban_infrastructure_2 = {	multiply_variable = { which = plague_urban_death value = 0.9 } }
						urban_infrastructure_3 = {	multiply_variable = { which = plague_urban_death value = 0.85 } }
						urban_infrastructure_4 = {	multiply_variable = { which = plague_urban_death value = 0.80 } }
						urban_infrastructure_5 = {	multiply_variable = { which = plague_urban_death value = 0.75 } }
					}
				}
			}
			if = {
				limit = { NOT = { check_variable = { which = province_plague_immunity value = 0 } } }
				multiply_variable = {	which = plague_urban_death			value = 0.004 }
				divide_variable = {		which = plague_rural_death			value = 400 }
			}
			else = {
				divide_variable = {		which = plague_urban_death			value = 300 }
				multiply_variable = {	which = plague_rural_death			value = 0.002 }
			}
			set_variable = {			which = plague_urban_density		which = urban_density }
			set_variable = {			which = plague_rural_density		which = rural_density }
			if = {
				limit = { check_variable = { which = plague_urban_density	value = 1 }
				}
				subtract_variable = {	which = plague_urban_density		value = 1 }
				multiply_variable = {	which = plague_urban_density		value = 0.5 }
				change_variable = {		which = plague_urban_density		value = 1 }
			}
			if = {
				limit = { check_variable = { which = plague_rural_density value = 1 } }
				subtract_variable = {	which = plague_rural_density		value = 1 }
				multiply_variable = {	which = plague_rural_density		value = 0.5 }
				change_variable = {		which = plague_rural_density		value = 1 }
			}
			multiply_variable = {		which = plague_urban_death			which = plague_urban_density }
			multiply_variable = {		which = plague_rural_death			which = plague_rural_density }
			set_variable = {			which = urban_percentage_removed	which = plague_urban_death }
			set_variable = {			which = rural_percentage_removed	which = plague_rural_death }
			#set_variable = {			which = plague_death_rural_count	value = 0 }
			#set_variable = {			which = plague_death_urban_count	value = 0 }
			#set_variable = {			which = plague_death_total_count	value = 0 }
			change_variable = {			which = plague_death_rural_count	which = rural_pop }
			change_variable = {			which = plague_death_urban_count	which = urban_pop }
			multiply_variable = {		which = plague_death_rural_count	which = rural_percentage_removed }
			multiply_variable = {		which = plague_death_urban_count	which = urban_percentage_removed }
			change_variable = {			which = plague_death_total_count	which = plague_death_rural_count }
			change_variable = {			which = plague_death_total_count	which = plague_death_urban_count }
			
			plague_add_immunity = yes	 #this improves immunity based on percent of province deaths.
			
			remove_urban_population_DEVS = yes
			remove_rural_population_DEVS = yes
			
			if = {
				limit = {
					OR = {
						is_city = yes
						is_colony = yes
					}
				}
				owner = { change_variable = { which = plague_death_rural_count	which = PREV } }
				owner = { change_variable = { which = plague_death_urban_count	which = PREV } }
				owner = { change_variable = { which = plague_death_total_count	which = PREV } }
				if = {
					limit = {
						has_global_flag = PT_L_init
					}
					plague_add_to_current = yes
				}
			}
			
			set_province_flag = plague_population_death_applied
			
			set_variable = { which = plague_death_rural_count			value = 0 }
			set_variable = { which = plague_death_urban_count			value = 0 }
			set_variable = { which = rural_percentage_removed			value = 0 }
			set_variable = { which = urban_percentage_removed			value = 0 }
			set_variable = { which = plague_death_total_count			value = 0 }
			set_variable = { which = plague_strength_local_adjusted		value = 0 }
			set_variable = { which = province_plague_doctors			value = 0 }
			set_variable = { which = plague_province_trauma				value = 0 }
			set_variable = { which = plague_urban_death					value = 0 }
			set_variable = { which = plague_rural_death					value = 0 }
			set_variable = { which = plague_urban_density				value = 0 }
			set_variable = { which = plague_rural_density				value = 0 }
		}
	}
}

plague_spread_port_effect = {
	if = {
		limit = {
			NOT = {
				has_province_flag = plague_attacked
				owner = { has_country_flag = plague_ports_closed }
			}
			has_port = yes
			sea_zone = {
				has_province_flag = plague_infected_waters
			}
		}
		set_variable = { which = plague_strength value = 0 }
		set_province_flag = plague_attacked_set
		sea_zone = {
			PREV = { set_variable = { which = plague_strength which = PREV } }
		}
	}
}

test_plague = {
	1402 = {
		set_province_flag = plague_spread_origin
		#fires at other centers of trade in the same trade node
		random_trade_node = {
			limit = {
				any_trade_node_member_province = {
					has_province_flag = plague_spread_origin
				}
			}
			every_trade_node_member_province = {
				limit = {
					has_province_flag = trade_center_modifier_has
				}
				add_permanent_province_modifier = {
					name = plague_devastating
					duration = 900
				}
			}
		}
	}
}
export_available_manpower = { #output
	export_to_variable = { which = $output$ value = manpower }
	export_to_variable = { which = temp value = trigger_value:num_of_infantry }
	change_variable = { which = $output$ which = temp }
	export_to_variable = { which = temp value = trigger_value:num_of_cavalry }
	change_variable = { which = $output$ which = temp }
	export_to_variable = { which = temp value = trigger_value:num_of_artillery }
	change_variable = { which = $output$ which = temp }
	export_to_variable = { which = temp value = trigger_value:num_of_mercenaries }
	subtract_variable = { which = $output$ which = temp }
	change_variable = { which = $output$ value = -2 } # off-by-one error
}